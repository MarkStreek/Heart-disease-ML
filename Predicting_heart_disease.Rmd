---
title: "Predicting Heart Disease"
author: "Mark van de Streek"
date: "`r Sys.Date()`"
output:
  pdf_document:
    number_sections: yes
  word_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Practical assignment bioinformatics - predicting heart diseases

```{r}
# Copyright (c) 2023 <Mark van de Streek>. 
# Licensed under GPLv3. See gpl.md
```

Loading all the packages that are necessary for this research.

```{r, echo=TRUE, error=FALSE, message=FALSE, warning=FALSE}
# Loading the packages
library(pander)
library(ggplot2)
library(GGally)
library(ggcorrplot)
library(gridExtra)
```

\newpage

# Introduction

This study examines a dataset \cite{dataset} on predicting heart disease based on
clinical variables.

The ultimate goal of this research is to create a machine learning model
that predicts whether a patient has heart disease.

The dataset contains data from people with and without a heart disease.
The last column shows whether the patient has heart disease (presence)
or not (absence). The logbook often refers to the classification column. It is then referred to as "presence" and "absence" of heart disease.

research question of the research: Which medical properties are important to be so accurate
possible to predict a heart condition/abnormality?

## Details of the data

The dataset contains data from 270 patients. There are 13 independent predictive variables for each patient. These variables are described in further detail in the codebook.

The dataset comes from the UCI repository. The Machine Learning Repository (UCI Repository) is a collection of databases and domains used by the machine learning community to create machine learning algorithms.

The dataset was created and merged by the following 4 agencies:

1. Hungarian Institute of Cardiology. Budapest: Andras Janosi, M.D.
2. University Hospital, Zurich, Switzerland: William Steinbrunn, M.D.
3. University Hospital, Basel, Switzerland: Matthias Pfisterer, M.D.
4. V.A. Medical Center, Long Beach and Cleveland Clinic Foundation: Robert Detrano, M.D., Ph.D.

The data was all collected in medical institutions. Good to remember that there can be a difference between medical equipment. However, these are of course not cheap devices that are found in the living room at home, for example. So the deviation will not be very large

## What is heart disease?

What is a heart disease and how many people have one. Why is this research important?

\newpage

# Exploration of the data

In the very first part of this logbook, the data will be examined exploratively. I.e., for example, the distribution of values, correlations, characteristics, etc. is looked at. This is all explained below.

## Data structure and Codebook

### Reading the data

Loading the data from the .csv file.

```{r}
data <- read.csv("Heart_Disease_Prediction.csv", header = T, sep = ",")
data <- data.frame(data)
```

An overview of the data will be stored inside a codebook, so it's easy to change/translate.
After that's done, it's easier to show all the columns' datatypes and
description.

```{r}
codebook <- data.frame(
  attributes = c("index", "Age", "Sex", "Chest.pain.type", 
                 "BP", "Cholesterol", "FBS.over.120", 
                 "EKG.results","Max.HR", "Exercise.angina", 
                 "ST.depression", "Slope.of.ST", "Number.of.vessels.fluro", 
                 "Thallium", "Heart.Disease"),
  unit = c("-", "years", "-", "-", "mm/Hg", "mg/dl","-", "-", "Beats/minute", 
           "-", "-", "-", "-", "-", "-"),
  dtype = c("int","int","factor","factor","int","int","factor","factor",
            "int","factor","int","factor","factor","factor","factor"),
  description = c("Patient number", "The age of the patient", 
                  "The gender of the patient", 
                  "The type of chest pain experienced by the patient", 
                  "The blood pressure level of the patient", 
                  "The cholesterol level of the patient", 
                  "The fasting blood sugar test results over 120 mg/dl", 
                  "The electrocardiogram results of the patient", 
                  "The maximum heart rate levels achieved during exercise testing", 
                  "The angina experienced during exercise testing", 
                  "The ST depression on a Electrocardiogram", 
                  "The slope of ST segment electrocardiogram readings", 
                  "The amount vessels seen in Fluoroscopy images", 
                  "Thallium Stress test findings", 
                  "Whether or not the patient has been diagnosed with Heart Disease"))
```

\newpage

### Description of the attributes

With the codebook we can print a overview of all the variables.

```{r}
# Print an overview of the columns with right datatypes and description
pander(codebook)
```

As shown above, the dataset contains some 'factor' attributes. These columns need some extra declaration to understand.

Additional description of nomial attriutes in the dataset:

1.  sex
    -   1 = Male

    -   0 = Female
2.  Chest pain type
    -   Value 1: Typical angina

    -   Value 2: Atypical angina

    -   Value 3: Non-anginal pain (pain without disease)

    -   Value 4: Asymptomatic
3.  EKG results
    -   Value 0: Normal

    -   Value 1: ST-T wave abnormality

    -   Value 2: Probable or definite LVH (thickening of the walls of
        the left ventricle, main chamber)
4.  FBS over 120 (Blood glucose level measured after fasting for at
    least 8 hours)
    -   Value 1: True

    -   Value 0: False
5.  Slope of ST Depression (Segment in EKG that may indicates a disease)
    -   Value 1: Up sloping

    -   Value 2: Flat

    -   Value 3: Down sloping
6.  Exercise induced angina (Narrowed blood vessels that deliver
    oxygen/nutrients to heart)
    -   Value 1 = Yes

    -   Value 0 = No
7.  Number of major vessels coloured by fluoroscopy
    -   range from 1 to 3
8.  Thallium (how much blood is reaching different parts of your heart)
    -   Value 3: Normal

    -   Value 6: Fixed defect

    -   Value 7: Reversible defect
    
\newpage

With all the right datatypes given, it is possible to change all the
columns to the right one. R does a good job by automatically choosing
the right datatype for the int/dbl columns. For that reason, you only
have to change the nominal datatypes. This is done below.

```{r}
for (i in 1:ncol(data)) {
  if (codebook[,3][i] == "factor") {
    data[, codebook[,1][i]] <- sapply(data[, codebook[,1][i]], as.factor)
  }
}
```

Now the data is all in the right datatypes, we can look at the
dimensions of the data.

```{r}
dims <- dim(data)
sprintf("Amount of rows: %.f, amount of columns: %.f", dims[1], dims[2])
```

The data contains 270 rows. That means there is data from 270 patients. This corresponds to expectations. For all these patients there are 14 values that say something about
that pearson. Not 15 because the first column is the index.

### Missing values

As the name says, this section will look at the missing values in the
dataset. Missing values can have major influence on the model. To make
sure there aren't a lot of missing values in the dataset, we will check
this with a simple loop.

```{r}
cat("Missing values:", any(is.na(data)))
```

As you can see above, there are no missing values in the dataset. beyond
that, there is little to say about it.

\newpage

## Univariate analysis

This section examines each variable in the dataset separately. The distribution of numerical values, outliers of numerical values and variation of ordinal values will be examined

### Variation of the data

There are a lot of numeric columns in the dataset. This means that the distribution shows us a good first impression of the data.

We will look at the nominal/ordinal values as well, so we're going to filter these first.

```{r}
numeric.columns <- c(2,5,6,9,11)
nominal.columns <- c(3,4,7,8,10,12,13,14,15)
```

#### Variation of numeric attributes

We made sure there aren't missing values in the dataset. Let's look at the range of columns.

```{r}
pander(summary(data[numeric.columns]))
```

Looking at the ST.depression, thit column has a wide range between minimum and maximum. The median and mean value is also far from the maximum. These could be outlier values, but it could also just be how the value is constructed.

\newpage

Now let's look at the distribution. This may give us a slightly clearer picture

```{r}
c1 <- ggplot(data, aes(x=Age)) + geom_histogram(bins = 15) + 
  labs(title = "Distribution Age Attribute") + xlab("Age (in years)") + 
  theme(axis.title.x = element_text(colour = "red", size = 8))

c2 <- ggplot(data, aes(x=BP)) + geom_histogram(bins = 10) + 
  labs(title = "Distribution Blood pressure Attribute") + 
  xlab("Blood pressure (in mm/HG)") + theme(axis.title.x = 
                                  element_text(colour = "red", size = 8))

c3 <- ggplot(data, aes(x = Cholesterol)) + geom_histogram(bins = 40) + 
  labs(title = "Distribution Cholesterol Attribute") + 
  xlab("log10 of Cholesterol in mg/dl") + 
  theme(axis.title.x = element_text(colour = "red", size = 8))

c4 <- ggplot(data, aes(x=Max.HR)) + geom_histogram(bins = 30) + 
  labs(title = "Distribution Max. heart rate Attribute") + 
  xlab("Heart beats (per minute)") + theme(axis.title.x = 
                                    element_text(colour = "red", size = 8))

c5 <- ggplot(data, aes(x=ST.depression)) + geom_histogram(bins = 30) + 
  labs(title = "Distribution ST depression Attribute") + 
  xlab("ST depression (in relative with the state of rest)") +
  theme(axis.title.x = element_text(colour = "red", size = 8))

grid.arrange(c1,c2,c3,c4,c5, ncol = 2)
```

The above graphs tells us that Cholesterol is quite well normal distributed. The same can be said for BP. Max.HR and Age appears to be split more towards the right. ST.depression shows a very high peak at the first bin.

Let's transform the data with log10 and see if the distribution is better/more observable.

```{r}
c1 <- ggplot(data, aes(x=log10(Age))) + geom_histogram(bins = 15) + 
  labs(title = "Distribution Age Attribute") + xlab("Age (in years)") + 
  theme(axis.title.x = element_text(colour = "red", size = 8))

c2 <- ggplot(data, aes(x=log10(BP))) + geom_histogram(bins = 10) + 
  labs(title = "Distribution Blood pressure Attribute") + 
  xlab("Blood pressure (in mm/HG)") + theme(axis.title.x = 
                                  element_text(colour = "red", size = 8))

c3 <- ggplot(data, aes(x = log10(Cholesterol))) + geom_histogram(bins = 40) + 
  labs(title = "Distribution Cholesterol Attribute") + 
  xlab("log10 of Cholesterol in mg/dl") + 
  theme(axis.title.x = element_text(colour = "red", size = 8))

c4 <- ggplot(data, aes(x=log10(Max.HR))) + geom_histogram(bins = 30) + 
  labs(title = "Distribution Max. heart rate Attribute") + 
  xlab("Heart beats (per minute)") + theme(axis.title.x = 
                                    element_text(colour = "red", size = 8))

c5 <- ggplot(data, aes(x=log10(ST.depression))) + geom_histogram(bins = 30) + 
  labs(title = "Distribution ST depression Attribute") + 
  xlab("ST depression (in relative with the state of rest)") +
  theme(axis.title.x = element_text(colour = "red", size = 8))

grid.arrange(c1,c2,c3,c4,c5, ncol = 2)
```

The cholesteral attribute is good normal distributed now. ST.depression is not good normal distributed but is more readable.

\newpage

With the distributions displayed, we can then begin to identify *possible* outliers. For this we use a violin plot. That's because a violin plot allows you to examine the distribution of the data and spot some outliers. It can also be immediately seen whether the outliers have a strong influence on the distribution.

```{r}
numeric.frame <- data.frame(
  labs = c(
  rep("Age", length(data$Age)),
  rep("BP", length(data$BP)),
  rep("Cholesterol", length(data$Cholesterol)),
  rep("Max.HR", length(data$Max.HR))),
  values = c(data$Age, data$BP, data$Cholesterol, data$Max.HR))

ggplot(numeric.frame, aes(x=labs, y=values, colour = labs)) + 
  theme(legend.position = "top") + coord_flip() + 
  geom_violin(trim = F, alpha = 1) + geom_jitter(position=position_jitter(0.2), 
                                                 alpha = 0.2) +
  labs(title = "Violin plot from the numeric attributes") +
  xlab("Attributes") + ylab("Values")
```

```{r}
numeric.frame <- data.frame(age = rep("Age", length(data$Age)),
                            BP = rep("BP", length(data$BP)),
                            age_value = data$Age,
                            BP.value = data$BP
  )

ggplot(numeric.frame, aes(x=BP, y=BP.value, colour = BP)) + 
  theme(legend.position = "top") + coord_flip() + 
  geom_violin(trim = F, alpha = 1) + geom_jitter(position=position_jitter(0.2), 
                                                 alpha = 0.2) +
  labs(title = "Violin plot from the numeric attributes") +
  xlab("Attributes") + ylab("Values")
```


The data contains few outliers. Only the cholesterol value has a number of points that differ slightly. But looking at the distribution, it still looks normal. We can conclude that:

- There are no major deviations in the distribution of the data
- The numerical data contain no notable outliers

\newpage

#### Variation of nominal/ordinal attributes

Let's look at the nominal values new. We are going to plot how often these occur. This is to be able to see whether all classes are represented.

```{r}
p1 <- ggplot(data, aes(x = Sex, fill = Sex)) + geom_bar()
p2 <- ggplot(data, aes(x = Chest.pain.type, fill = Chest.pain.type)) + geom_bar()
p3 <- ggplot(data, aes(x = FBS.over.120, fill = FBS.over.120)) + geom_bar()
p4 <- ggplot(data, aes(x = EKG.results, fill = EKG.results)) + geom_bar()
p5 <- ggplot(data, aes(x = Exercise.angina, fill = Exercise.angina)) + geom_bar()
p6 <- ggplot(data, aes(x = Slope.of.ST, fill = Slope.of.ST)) + geom_bar()
p7 <- ggplot(data, aes(x = Number.of.vessels.fluro)) + geom_bar()
p8 <- ggplot(data, aes(x = Thallium, fill = Thallium)) + geom_bar()
p9 <- ggplot(data, aes(x = Heart.Disease, fill = Heart.Disease)) + geom_bar()

grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9, ncol = 3, 
             top = "Barplots of all the nominal/ordinal valus")
```

The dataset contains more man than women. Most values lean towards 'healthy' people. There are also more people who do not have a condition than do. So this difference partly comes from here. However, there are also many people who do have a condition, but have few or no complaints, for example, see figure Chest.pain.type. 

conclusions:

- Comparatively few people have an FBS of over 120
- There seems to be enough distribution in these attributes to train a good model (this says nothing about the usability of all attributes)

\newpage

### Class distribution

For our model it's important to know how the classes are distributed. We
can have a big dataset, but if it's only "absence" people, we can't say
much about it.

```{r}
df <- data.frame(
  group = c("Presence", "Absence"),
  value = c(sum(data[15] == "Presence"), sum(data[15] == "Absence"))
)

ggplot(df, aes(x = "", y = value, fill = group)) +
  geom_col(color = "black") +
  geom_text(aes(label = value),
            position = position_stack(vjust = 0.5)) +
  coord_polar(theta = "y") + labs(title = "Pie chart of class distribution", 
  subtitle = "The number of people per group") + theme_void() + 
  theme(legend.position = "bottom", plot.title = element_text(face = "bold", 
      size = 18, hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) 
```

As you can see, the classes are not exactly evenly represented. But it
certainly has no major deviation.

\newpage

## Bivariate analysis

In this sector, not one, but several variables are considered. By this we mean that we will look at each other. For example, how much correlation certain attributes have. First, we will compare age between groups

### Age difference between class

Perhaps the most global characteristic to look at first is age. Let's take a closer look at the patients and perhaps spot some initial differences. Maybe a conclusion can already be drawn with this attribute. You would think that patients are more likely to develop a disease as they get older.

```{r}
age.frame <- data.frame(
  Patient = c(rep("Presence", length(data$Age[data$Heart.Disease == "Presence"])
), rep("Absence", length(data$Age[data$Heart.Disease == "Absence"])
)),
  years = c(data$Age[data$Heart.Disease == "Presence"], 
             data$Age[data$Heart.Disease == "Absence"])
)

ggplot(age.frame, aes(x = Patient, y = years, fill=Patient)) + 
  geom_boxplot() + labs(title = "Boxplot from patients age", 
                        subtitle = "Ages between presence and Absence") + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20), 
        plot.subtitle = element_text(hjust = 0.5)) + ylab("Age (in years)")
```

The results show that the age is slightly higher in the presence group.
It can be concluded that patients with a presence-condition are often
slightly older.

we can test this by performing a statistical test.

```{r}
test <- t.test(data$Age[data$Heart.Disease == "Presence"], 
       data$Age[data$Heart.Disease == "Absence"], alternative = "greater")
cat("P-value: ", test$p.value)
```

The P-value of the test is 0.0001763. This means that with alpha = 0.05, the P-value is less than 0.05. There is a significant age difference between the presence and absence groups. The average age in the group with heart disease is significantly higher.

### Comparing related attributes

There are a few values that relate to each other. Values can be related to each other, but that doesn't necessarily mean anything. Let's see if differences can be spotted between attributes that are related to each other.

First, let's have a look at the cholesterol and the Exercise angina. As told earlier, exercise angina is a narrowed blood vessels that deliver oxygen/nutrients to heart. It can be examined whether there may be a relationship between these two. Because a narrowed blood vessel can be caused by high cholesterol **(Harvard Health, 2021)**.

```{r}
related.frame <- data.frame(
  labs = c(
    rep("1", length(data$Exercise.angina[data$Exercise.angina == "1"])),
    rep("0", length(data$Exercise.angina[data$Exercise.angina == "0"]))),
  cholesterol = c(data$Cholesterol[data$Exercise.angina == "1"], 
             data$Cholesterol[data$Exercise.angina == "0"]))

ggplot(related.frame, aes(x = labs, y = cholesterol, fill = labs)) + geom_boxplot() +
  labs(title = "Boxplot from Exercise angina against cholesterol", 
                        subtitle = "0 = No, 1 = Yes") + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20), 
        plot.subtitle = element_text(hjust = 0.5)) +
  ylab("Cholesterol (in mg/dl)")
```

the boxes of the boxplot differ slightly, but this does not seem to be a big difference. Let's confirm this with a statistical test.

```{r}
test <- t.test(data$Cholesterol[data$Exercise.angina == "0"],
               data$Cholesterol[data$Exercise.angina == "1"], 
               alternative = "two.sided")
cat("P-value: ", test$p.value)
```

as expected, the p-value (0.182) is greater than 0.05. So there is no significant difference between the two groups.

There are two more attributes that might be interesting. People with a heart condition often have an abnormal heart rate **(Perret‐Guillaume et al., 2009)**. It is possible to make this comparison and see if there is a difference. However, we are talking about the maximum heart rate here. This may therefore be different from the heart rate at rest.

```{r}
related.frame <- data.frame(
  labs = c(
    rep("Presence", length(data$Heart.Disease[data$Heart.Disease == "Presence"])),
    rep("Absence", length(data$Heart.Disease[data$Heart.Disease == "Absence"]))),
  values = c(data$Max.HR[data$Heart.Disease == "Presence"], 
             data$Max.HR[data$Heart.Disease == "Absence"]))

ggplot(related.frame, aes(x = labs, y = values, fill = labs)) + geom_boxplot() +
  labs(title = "Boxplot from disease against Heart rate", 
                        subtitle = "Heart rate as maximum heart rate") + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20), 
        plot.subtitle = element_text(hjust = 0.5)) + xlab("Group") +
  ylab("Heart rate (in beats/minute")
```

```{r}
test <- t.test(data$Max.HR[data$Heart.Disease == "Presence"], 
               data$Max.HR[data$Heart.Disease == "Absence"], 
               alternative = "two.sided")
cat("P-value: ", test$p.value)
```

as the test shows, there is a significant difference. But these results are not entirely conclusive. As age increases, the maximum heart rate also decreases. With this figure and test no conclusion can be drawn about this comparison.

\newpage

### Corrolation between attributes

As mentioned earlier, the main goal of this research was to develop a
machine learning model. For this model, it is useful to see which
attributes may be important. We will compare all numeric attributes with each other. The goal is to demonstrate similarities or differences.

Scatterplots are plotted between all attributes. This makes it possible to see how far apart the groups presence/absence are. Or just how close they are to each other.

```{r}
ggpairs( data[numeric.columns], ggplot2::aes(colour=data$Heart.Disease), 
         progress = F, upper = "blank", legend = 1) + 
  labs(title = "Pairplot of the numeric attributes") + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20), axis.text.y = element_blank(), legend.position = "bottom")
```

The figure above shows a number of things. It shows the similarities between all variables. However, it is of course much clearer to simply attach a number to the similarities. This happens below with a correlation heat map.

Conclusions pairplot:

- There is a small similaritie in the age attribute
- The maximum heart rate appears to be lower in people who have a condition

\newpage

```{r}
colMA <- function(n = 3) {
  colorRampPalette(c("#F4DF4EFF", "#949398FF"), space = "rgb")(n)
}

# plotting corr heatmap
ggcorrplot(cor(data[numeric.columns]), colors = colMA(), 
           lab = T, lab_col = "white", lab_size = 3) +
  labs(title = "Correlation Heatmap of the numeric attributes") + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20)) 
```

The output tells us that there are some values that are slightly to moderately correlated. Blood pressure and age have the highest correlation. Furthermore, there are no values that stand out. ST depression and maximum heart rate have the least correlation

Conclusion:

- BP and Age have the highest correlation
- There are no major correlations that *could* cause any over fitting

\newpage

### Similarities in the nominal attributes

In the last part of the EDA we will look at some similarities between ordinal values. First of all, let's see if sex still has an influence. We do this in this section because it concerns a comparison with two ordinal groups. For this we must use the Chi-square test

```{r}
table(data$Sex, data$Heart.Disease)
chisq.test(data$Sex, data$Heart.Disease, correct = FALSE)
```
The table already shows that there is a difference of 80 between men and women. The p-value is less than 0.05 and this therefore rejects the null hypothesis: independent.

- The attributes Sex and Heart.disease are strongly related to each other

Take for example the ECG results and the ST depression. These are both related to the ECG results. Let's see if these values are actually related to each other

```{r}
chisq.test(data$Slope.of.ST, data$EKG.results, correct = FALSE)
```

The test shows that the p-value is again less than 0.05. However, this is only slightly smaller than 0.05. It is not possible to draw a conclusion from this. That's strange, because Slope.ST says something about the EKG results. But this can of course be due to many factors.

\newpage

```{=tex}
\begin{thebibliography}{3}

\bibitem{dataset}
(2023, 12 januari).: \textit{Predicting heart disease using clinical variables}. <https://www.kaggle.com/datasets/thedevastator/predicting-heart-disease-risk-using-clinical-var>

\bibitem{angina_chol}
Harvard Health. (2021, 21 september).: \textit{Angina: Symptoms, diagnosis and Treatments}. 
<https://www.health.harvard.edu/heart-health/angina-symptoms-diagnosis-and-treatments>

\bibitem{maxHR}
Perret‐Guillaume, C., Joly, L. Bénétos, A. (2009).: \textit{Heart rate as a risk factor for cardiovascular disease. Progress in Cardiovascular Diseases, 52(1), 6–10}

\end{thebibliography}
```

# Clean Dataset

As told earlier, some columns have been log10 transformed. We are now going to make a 'clean' dataset. I.e., a dataset with usable columns and with the right range.

Let's delete the index column. This column is unnecessary and we don't need it for our machine learning model later on.

```{r}
data <- data[ -c(1) ]
```

Now let's add columns for transformation. We have already told you for which column this is necessary. We will simply add a new column to the dataset with transformation. This is because we can always reuse the original data if we need it.

```{r}
data$Cholesterol.transformed <- log10(data$Cholesterol)
data$ST.depression.transformed <- log10(data$ST.depression)
```

For the clean dataset it is also easy to read a number of values more quickly. Numbers cannot be read quickly, so we will convert some (simple) values into words. It becomes very confusing to convert all the ordinal attributes into words/description

```{r}
levels(data$Sex) <- c("Male", "Female")
levels(data$FBS.over.120) <- c(FALSE, TRUE)
levels(data$Exercise.angina) <- c("No", "Yes")
```

There is now a clean data set. We are going to save this in a new CSV file so that we can use it later.

```{r}
write.csv(data, "clean_dataset_Heart_disease_predicting.csv", row.names = F)
```




- verglijk de log10 resultaten met normale restulaten
- 4 kleine violin plots
- Alle waardes vergelijken met absence/presence, dus numeriek en ordinaal
- combineer ook alle p-waardes
- heatmap met twee kleuren uiteinde
- geen overfitting, maar vullen elkaar goed aan
- alle p-waardes combineren in een tabel
- te veel verslaglegging





