---
title: "Thema 09 - ML log"
author: "Mark van de Streek"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Practical assignment bioinformatics - predicting heart diseases

```{r}
# Copyright (c) 2023 <Mark van de Streek>. 
# Licensed under GPLv3. See gpl.md
```

```{r}
# Loading the packages
library(pander)
library(ggplot2)
library(GGally)
library(ggcorrplot)
library(gridExtra)
```

\newpage

## 1. Introduction

Vraag: Welke medische eigenschappen zijn belangrijk om zo nauwkeurig
mogelijk een hart aandoening/afwijking te voorspellen?

Dataset:
<https://www.kaggle.com/datasets/thedevastator/predicting-heart-disease-risk-using-clinical-var>

This study examines a dataset on predicting heart disease based on
clinical variables.

The ultimate goal of this research is to create a machine learning model
that predicts whether a patient has heart disease.

The dataset contains data from people with and without a heart disease.
The last column shows whether the patient has heart disease (presence)
or not (absence).

### 1.1 Details of the data

Where did the data came from?
what the dependent / class variable is?

\newpage

## 2. Exploration of the data

This study examines a dataset on predicting heart disease based on
clinical variables. This means that distribution will be inspected,
among other important subjects.

### 2.1 Reading the data

First, the data is going to be loaded in R. This is done below. The
pander library is being used for a good but simple overview of the data.
And lastly, the data will be put in the right datatype.

It's important to have the variables in the right datatype, because this
is very important for our machine learning model. More on that, later in
the research.

```{r}
data <- read.csv("Heart_Disease_Prediction.csv", header = T, sep = ",")
data <- data.frame(data)
```

An overview of the data will be stored inside a codebook, so it's easy to change/translate.
After that's done, it's easier to show all the columns' datatypes and
description.

```{r}
codebook <- data.frame(
  attributes = c("index", "Age", "Sex", "Chest.pain.type", 
                 "BP", "Cholesterol", "FBS.over.120", 
                 "EKG.results","Max.HR", "Exercise.angina", 
                 "ST.depression", "Slope.of.ST", "Number.of.vessels.fluro", 
                 "Thallium", "Heart.Disease"),
  unit = c("-", "years", "-", "-", "mm/Hg", "mg/dl","-", "-", "Beats/minute", 
           "-", "-", "-", "-", "-", "-"),
  dtype = c("int","int","factor","factor","int","int","factor","factor",
            "int","factor","int","factor","factor","factor","factor"),
  description = c("Patient number", "The age of the patient", 
                  "The gender of the patient", 
                  "The type of chest pain experienced by the patient", 
                  "The blood pressure level of the patient", 
                  "The cholesterol level of the patient", 
                  "The fasting blood sugar test results over 120 mg/dl", 
                  "The electrocardiogram results of the patient", 
                  "The maximum heart rate levels achieved during exercise testing", 
                  "The angina experienced during exercise testing", 
                  "The ST depression on a Electrocardiogram", 
                  "The slope of ST segment electrocardiogram readings", 
                  "The amount vessels seen in Fluoroscopy images", 
                  "Thallium Stress test findings", 
                  "Whether or not the patient has been diagnosed with Heart Disease"))
```

\newpage

### 2.2 Description of the attributes

With the codebook we can print a overview of all the variables.

```{r}
# Print an overview of the columns with right datatypes and description
pander(codebook)
```

As shown above, the dataset contains some 'factor' attributes. These columns need some extra declaration to understand.

Additional description of nomial attriutes in the dataset:

1.  sex
    -   1 = Male

    -   0 = Female
2.  Chest pain type
    -   Value 1: Typical angina

    -   Value 2: Atypical angina

    -   Value 3: Non-anginal pain (pain without disease)

    -   Value 4: Asymptomatic
3.  EKG results
    -   Value 0: Normal

    -   Value 1: ST-T wave abnormality

    -   Value 2: Probable or definite LVH (thickening of the walls of
        the left ventricle, main chamber)
4.  FBS over 120 (Blood glucose level measured after fasting for at
    least 8 hours)
    -   Value 1: True

    -   Value 0: False
5.  Slope of ST Depression (Segment in EKG that may indicates a disease)
    -   Value 1: Up sloping

    -   Value 2: Flat

    -   Value 3: Down sloping
6.  Exercise induced angina (Narrowed blood vessels that deliver
    oxygen/nutrients to heart)
    -   Value 1 = Yes

    -   Value 0 = No
7.  Number of major vessels coloured by fluoroscopy
    -   range from 1 to 3
8.  Thallium (how much blood is reaching different parts of your heart)
    -   Value 3: Normal

    -   Value 6: Fixed defect

    -   Value 7: Reversible defect
    
\newpage

With all the right datatypes given, it is possible to change all the
columns to the right one. R does a good job by automatically choosing
the right datatype for the int/dbl columns. For that reason, you only
have to change the nominal datatypes. This is done below.

```{r}
for (i in 1:ncol(data)) {
  if (codebook[,3][i] == "factor") {
    data[, codebook[,1][i]] <- sapply(data[, codebook[,1][i]], as.factor)
  }
}
```

Now the data is all in the right datatypes, we can look at the
dimensions of the data.

```{r}
dims <- dim(data)
sprintf("Amount of rows: %.f, amount of columns: %.f", dims[1], dims[2])
```

The data contains 270 rows. That means there is data from 270 patients.
And for all these patients there are 14 values that say something about
that pearson. Not 15 because the first column is the index.

It can be concluded that this dataset is fits well for the goal we want
to achieve. This because it contains a couple of important variables
that can say something about our patient and most important, the data
has a classification column. With classification column will allow to
train our model later on. However, we have not yet looked at all
research topics to draw this conclusion.

\newpage

### 2.3 Missing values

As the name says, this section will look at the missing values in the
dataset. Missing values can have major influence on the model. To make
sure there aren't a lot of missing values in the dataset, we will check
this with a simple loop.

```{r}
cat("Missing values:", any(is.na(data)))
```

As you can see above, there are no missing values in the dataset. beyond
that, there is little to say about it.

### 2.4 Variation of the data

There are a lot of numeric columns in the dataset. This means that the distribution shows us a good first impression of the data.

We will look at the nominal/ordinal values as well, so we're going to filter these first.

```{r}
numeric.columns <- c(2,5,6,9,11)
nominal.columns <- c(3,4,7,8,10,12,13,14,15)
```

#### 2.4.1 Variation of numeric attributes

We made sure there aren't missing values in the dataset. Let's look at the range of columns.

```{r}
pander(summary(data[numeric.columns]))
```

Looking at the ST.depression, thit column has a wide range between minimum and maximum. The median and mean value is also far from the maximum. These could be outlier values, but it could also just be how the value is constructed.

Now let's look at the distribution. This may give us a slightly clearer picture

```{r}
c1 <- ggplot(data, aes(x=log10(Age))) + geom_histogram(bins = 15)
c2 <- ggplot(data, aes(x=log10(BP))) + geom_histogram(bins = 10)
c3 <- ggplot(data, aes(x=log10(Cholesterol))) + geom_histogram(bins = 40)
c4 <- ggplot(data, aes(x=log10(Max.HR))) + geom_histogram(bins = 30)
c5 <- ggplot(data, aes(x=log10(ST.depression))) + geom_histogram(bins = 30)

grid.arrange(c1,c2,c3,c4,c5, ncol = 2)
```

The above graphs tells us that Cholesterol is quite well distributed. The same can be said for BP. Max.HR, Age and ST.depression appears to be split more towards the right.

With the distributions displayed, we can then begin to identify *possible* outliers.

```{r}
numeric.frame <- data.frame(
  labs = c(
  rep("Age", length(data$Age)),
  rep("BP", length(data$BP)),
  rep("Cholesterol", length(data$Cholesterol)),
  rep("Max.HR", length(data$Max.HR))),
  values = c(data$Age, data$BP, data$Cholesterol, data$Max.HR))

ggplot(numeric.frame, aes(x=labs, y=values, colour = labs)) + theme(legend.position = "top") + coord_flip() + geom_violin(trim = F, alpha = 1) + geom_jitter(position=position_jitter(0.2), alpha = 0.2)
```
The data contains few outliers. Only the cholesterol value has a number of points that differ slightly. But looking at the distribution, it still looks normal. We can conclude that:

- There are no major deviations in the distribution of the data
- The numerical data contain no notable outliers

#### 2.4.2 Variation of nominal/ordinal attributes

Let's look at the nominal values new. We are going to plot how often these occur.

```{r}
p1 <- ggplot(data, aes(x = Sex, colour = Sex)) + geom_bar()
p2 <- ggplot(data, aes(x = Chest.pain.type, colour = Chest.pain.type)) + geom_bar()
p3 <- ggplot(data, aes(x = FBS.over.120, colour = FBS.over.120)) + geom_bar()
p4 <- ggplot(data, aes(x = EKG.results, colour = EKG.results)) + geom_bar()
p5 <- ggplot(data, aes(x = Exercise.angina, colour = Exercise.angina)) + geom_bar()
p6 <- ggplot(data, aes(x = Slope.of.ST, colour = Slope.of.ST)) + geom_bar()
p7 <- ggplot(data, aes(x = Number.of.vessels.fluro)) + geom_bar()
p8 <- ggplot(data, aes(x = Thallium, colour = Thallium)) + geom_bar()
p9 <- ggplot(data, aes(x = Heart.Disease, colour = Heart.Disease)) + geom_bar()

grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9, ncol = 3)
```

The dataset contains more man than women. Most values lean towards 'healthy' people. There are also more people who do not have a condition than do. So this difference partly comes from here. However, there are also many people who do have a condition, but have few or no complaints, for example, see figure Chest.pain.type. 

Perhaps the most global characteristic to look at first is age. Let's take a closer look at the patients and perhaps spot some initial differences. Maybe a conclusion can already be drawn with this attribute. You would think that patients are more likely to develop a disease as they get older.

```{r}
age.frame <- data.frame(
  Patient = c(rep("Presence", length(data$Age[data$Heart.Disease == "Presence"])
), rep("Absence", length(data$Age[data$Heart.Disease == "Absence"])
)),
  values = c(data$Age[data$Heart.Disease == "Presence"], data$Age[data$Heart.Disease == "Absence"])
)

ggplot(age.frame, aes(x = Patient, y = values, color=Patient)) + geom_boxplot() + labs(title = "Boxplot from patients age", subtitle = "Ages between presence and Absence") + theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 20), plot.subtitle = element_text(hjust = 0.5)) + scale_color_manual(values=c( "#949398FF", "#F4DF4EFF"))
```

The results show that the age is slightly higher in the presence group.
It can be concluded that patients with a presence-condition are often
slightly older.

### 2.5 Comparison between values

there are a few values that relate to each other. Take, for example, the ECG results and the ST depression. These both have to do with the ECG results. Attributes can now be examined to see whether they show any notable differences.

First, let's have a look at the cholesterol and the Exercise angina. As told earlier, exercise angina is a narrowed blood vessels that deliver oxygen/nutrients to heart. It can be examined whether there may be a relationship between these two. Because a narrowed blood vessel can be caused by high cholesterol.

```{r}
boxplot(data$Cholesterol ~ data$Exercise.angina)
boxplot(data$Max.HR ~ data$Thallium)
```

...

### 2.5 Class distribution

For our model it's important to know how the classes are distributed. We
can have a big dataset, but if it's only "absence" people, we can't say
much about it.

```{r}
df <- data.frame(
  group = c("Presence", "Absence"),
  value = c(sum(data[15] == "Presence"), sum(data[15] == "Absence"))
)

ggplot(df, aes(x = "", y = value, fill = group)) +
  geom_col(color = "black") +
  geom_text(aes(label = value),
            position = position_stack(vjust = 0.5)) +
  coord_polar(theta = "y") + labs(title = "Pie chart of class distribution", subtitle = "The number of people per group") + theme_void() + theme(legend.position = "bottom", plot.title = element_text(face = "bold", size = 18, hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) 
```

As you can see, the classes are not exactly evenly represented. But it
certainly has no major deviation.

### 2.6 Corrolation between attributes

As mentioned earlier, the main goal of this research was to develop a
machine learning model. For this model, it is useful to see which
attributes may be important.

```{r}
ggpairs( data[numeric.columns], ggplot2::aes(colour=data$Heart.Disease), progress = F, upper = "blank")
```

The figure above shows a number of things. It shows the similarities between all variables. By looking at the points you can see how much correlation they have. However, it is of course much clearer to simply attach a number to the correlation. This happens below.

```{r}
colMA <- function(n = 3) {
  colorRampPalette(c("#F4DF4EFF", "#949398FF"), space = "rgb")(n)
}

# plotting corr heatmap
ggcorrplot(cor(data[numeric.columns]), colors = colMA(), 
           lab = T, lab_col = "white", lab_size = 3)

```

# ToDo:

- Translate boxplots to GGPLOT2
- Add some proper english/conclusions
- Tussen twee nominale waardes: kruistabel en/of Chi^2 toets






